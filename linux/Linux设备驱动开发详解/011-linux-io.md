# 第11章 内存与I/O访问

- 常规内存、高端内存、虚拟地址、逻辑地址、总线地址、物理地址、I/O内存、设备内存、预留内存等概念
- 内存空间、I/O空间和MMU
- Linux的内存管理、内存区域的分布、常规内存与高端内存的区别。
- Linux内存存取的方法
- 内存动态申请以及通过虚拟地址存取物理地址的方法
- 设备I/O端口和I/O内存的访问流程
- 解I/O内存静态映射
- 设备驱动中的DMA与Cache一致性问题以及DMA的编程方法。
- 内存空间是必需的，而I/O空间是可选的
- 内存管理单元 MMU
- TLB（Translation Lookaside Buffer）
- TTW（Translation Table walk）
- pin_page_for_write
-
-
-
-
-
-
-
-
-
-

## 内存空间是必需的，而I/O空间是可选的

![011-linux-io](images/011-linux-io.png)


## 内存管理单元

高性能处理器一般会提供一个内存管理单元
（MMU），该单元辅助操作系统进行内存管理，提供虚
拟地址和物理地址的映射、内存访问权限保护和Cache
缓存控制等硬件支持。操作系统内核借助MMU可以让用
户感觉到程序好像可以使用非常大的内存空间，从而
使得编程人员在写程序时不用考虑计算机中物理内存
的实际容量。

1）TLB（Translation Lookaside Buffer）：即
转换旁路缓存，TLB是MMU的核心部件，它缓存少量的
虚拟地址与物理地址的转换关系，是转换表的Cache，
因此也经常被称为“快表”。


2）TTW（Translation Table walk）：即转换表
漫游，当TLB中没有缓冲对应的地址转换关系时，需要
通过对内存中转换表（大多数处理器的转换表为多级
页表，如图11.2所示）的访问来获得虚拟地址和物理
地址的对应关系。TTW成功后，结果应写入TLB中


![011-mmu-table](images/011-mmu-table.png)

## ARM处理器的MMU

![ARM处理器的MMU](images/011-mmu-arm.png)


MMU具有虚拟地址和物理地址转换、内存访问权限
保护等功能，这将使得Linux操作系统能单独为系统的
每个用户进程分配独立的内存空间并保证用户空间不
能访问内核空间的地址，为操作系统的虚拟内存管理
模块提供硬件基础。


在Linux 2.6.11之前，Linux内核硬件无关层使用
了三级页表PGD、PMD和PTE；从Linux 2.6.11开始，为
了配合64位CPU的体系结构，硬件无关层则使用了4级
页表目录管理的方式，即PGD、PUD、PMD和PTE。注意
这仅仅是一种软件意义上的抽象，实际硬件的页表级
数可能少于4。代码清单11.1给出了一个典型的从虚拟
地址得到PTE的页表查询（Page Table Walk）过程，
它取自arch/arm/lib/uaccess_with_memcpy.c。

## Linux内存管理

对于包含MMU的处理器而言，Linux系统提供了复
杂的存储管理系统，使得进程所能访问的内存达到
4GB。
在Linux系统中，进程的4GB内存空间被分为两个
部分——用户空间与内核空间。用户空间的地址一般
分布为0~3GB（即PAGE_OFFSET，在0x86中它等于
0xC0000000），这样，剩下的3~4GB为内核空间，如图
11.5所示。用户进程通常只能访问用户空间的虚拟地
址，不能访问内核空间的虚拟地址。用户进程只有通
过系统调用（代表用户进程在内核态执行）等方式才
可以访问到内核空间。

![alt text](images/011-linux-mem.png)


每个进程的用户空间都是完全独立、互不相干
的，用户进程各自有不同的页表。而内核空间是由内
核负责映射，它并不会跟着进程改变，是固定的。内
核空间的虚拟地址到物理地址映射是被所有进程共享
的，内核的虚拟空间独立于其他程序。
Linux中1GB的内核地址空间又被划分为物理内存
映射区、虚拟内存分配区、高端页面映射区、专用页
面映射区和系统保留映射区这几个区域，如图11.6所
示。

![alt text](images/011-linux-32-mem.png)

对于x86系统而言，一般情况下，物理内存映射区
最大长度为896MB，系统的物理内存被顺序映射在内核
空间的这个区域中。当系统物理内存大于896MB时，超
过物理内存映射区的那部分内存称为高端内存（而未
超过物理内存映射区的内存通常被称为常规内存），
内核在存取高端内存时必须将它们映射到高端页面映
射区。