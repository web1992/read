# 第 5 章　分代 G1GC 模式

- 纯 G1GC 模式
- 纯 G1GC 模式
- 新生代 GC ：minor GC，分代 GC 中针对新生代对象的垃圾回收。
- 老年代 GC ：major GC，分代 GC 中针对老年代对象的垃圾回收。
- 对象的年龄
- 晋升
- 新生代区域
- 创建区域
- 存活区域
- 老年代区域
- 分代对象转移
- 执行过程简述
- 分代选择回收集合
- 完全新生代，完全新生代 GC 会选择所有新生代区域
- 部分新生代，部分新生代 GC 会选择所有新生代区域和一部分老年代区域
- 设置最大新生代区域数
- GC 的切换
- GC 执行的时机

G1GC 中存在“纯 G1GC 模式”（pure garbage-first mode）和“分代 G1GC模式”（generational garbage-first mode）两种模式。前面介绍的内容都是关于纯 G1GC 模式的。本章，我们将介绍分代 G1GC 模式。本书之所以先介绍纯 G1GC 模式，是为了便于大家理解。实际上，OpenJDK 虽然实现了纯 G1GC 模式，但是并没有将这种模式开放给用户。用户们使用的都是分代 G1GC 模式。

和纯 G1GC 模式相比，分代 G1GC 模式主要有以下两个不同点。
- 区域是分代的
- 回收集合的选择是分代的

## GC 名称

- G1GC 中的新生代 GC 称为完全新生代 GC（fully-young collection）
- 老年代 GC称为部分新生代 GC（partially-young collection）

完全新生代 GC 和部分新生代 GC 的主要区别在于回收集合的选择。完全新生代 GC 将所有新生代区域选入回收集合，而部分新生代 GC 将所有新生代区域，以及一部分老年代区域选入回收集合。

这里需要注意的是，`所有的新生代区域`都会被选入回收集合。这一点非常重要，请务必牢记。

## 新生代区域

新生代区域可以进一步分为以下两类。

- 创建区域
- 存活区域

创建区域用来存放刚刚生成、一次也没有被转移过的对象。存活区域用来存放被转移过至少一次的对象

另外，转移专用写屏障不会应用在新生代区域的对象上。因此，即使新生代区域的对象存在对其他区域对象的引用，被引用区域的转移专用记忆集合中也不会记录引用方的卡片。

但是，为什么不使用转移专用写屏障也可以呢？我们先回顾一下转移专用记忆集合的作用。转移专用记忆集合维护的是区域之间的引用关系，因此在转移时无须扫描整个区域就能找到待转移对象所在区域的存活对象。而在分代 G1GC 模式中，所有的新生代区域都会被选入回收集合，因此在转移新生代区域时所有对象的引用都会被检查。即使被引用区域的转移专用记忆集合中记录了来自新生代区域的引用，这些记录也都是重复的信息。因此，转移专用记忆集合中不会记录来自新生代区域的引用。(5.2)

## 分代对象转移

存活对象保存了自己被转移的次数，这个次数称为对象的年龄。转移时对象的年龄如果低于阈值，对象就会被转移到存活区域，否则就会被转移到老年代区域。将对象转移到老年代区域的行为称为晋升。

如果转移的目标区域满了，垃圾回收器就会选择一个空闲的区域，把它修改成存活区域或者老年代区域之后，作为转移的目标区域使用。对象被转移到存活区域之后，即使该对象引用了回收集合以外的区域，也不需要记录在转移专用记忆集合中。关于这一点的原因，5.2 节的后半部分已经介绍过了。相反，往老年代区域转移对象时就必须要记录。因为老年代区域并非每次都会被选入回收集合。

## 新生代的执行过程

完全新生代 GC 不会选择老年代区域，而是将所有新生代区域都选入回收集合，然后转移回收集合内的存活对象。晋升的对象会被转移到老年代区域，其余对象则被转移到存活区域。

## 完全新生代 GC

完全新生代 GC 的最大新生代区域数是在遵守 GC 暂停时间上限的前提下，尽量设置较大的值。即根据过去的转移时间记录，预测出单个新生代区域转移所需的大概时间，然后基于这个时间计算出刚好不超过 GC暂停时间上限的最大新生代区域数。完全新生代 GC 的名字由来就是`尽可能完全地转移新生代区域`。

## GC 执行的时机

当新生代区域数达到上限时，会触发转移的执行。换句话说，通过调节最大新生代区域数，可以控制转移执行的时机。

当转移完成并通过以下 4 项检查之后，会开始执行并发标记。
- ①不在并发标记执行过程中
- ②并发标记的结果已被上次转移使用完
- ③已经使用了一定量的堆内存（默认是全部堆内存的 45% 以上）
- ④相比上次转移完成之后，堆内存的使用量有所增加

其中②是为了避免重复地并发标记。如果有并发标记的结果尚未在转移过程中被使用，则不会开始并发标记。

需要注意的是，并发标记过程中的所有暂停处理都需要遵守程序对于GC 暂停处理的调度（4.4 节），以适当的时间间隔来执行。