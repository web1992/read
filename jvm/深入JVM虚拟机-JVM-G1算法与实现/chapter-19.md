# 第 19 章　准确式 GC 的实现

- 准确式 GC（exact GC）
- 栈图
- 栈图表示的是指向 VM 栈内所有对象的指针的位置
- 字节码解释器
- 基本类型和引用类型
- 抽象解释器
- 发生 GC 时，栈图是被创建
- 基本块（basic block）
- 栈帧执行时的栈图
- 方法调用时的栈图
- 已编译的栈帧
- JIT 在将方法编译为机器语言的同时也会创建栈图
- 句柄区域与句柄标记

## 栈图

为了实现准确式 GC，HotSpotVM 在进行 GC 时会生成“栈图”。栈图表示的是指向 VM 栈内所有对象的指针的位置。

## 已编译的栈帧

JIT 在将方法编译为机器语言的同时也会创建栈图。对于已编译的方法来说，栈图表示的是在某栈帧内的什么位置有引用类型，或者是在哪个寄存器中有引用类型。

用 JIT 创建栈图时必须格外注意创建的位置。这是因为每执行一条机器语言指令，栈和寄存器的状态都会发生变化。因此理论上来说，JIT 必须创建对应各条指令的栈图。不过，这样做会使栈图变得非常庞大，所以基本上仅会在以下情况下使用 JIT 创建栈图。

- ①后方分支（例：在循环中跳转至后面）
- ②方法调用
- ③ return
- ④执行可能会发生异常的指令时


这里令我稍微感到疑惑的是：“JIT 在编译时就会确定栈图吗？”不过细细思考后我明白了，JIT 可以从 Java 的助记符的类型信息中获知引用类型的值，而且它自己也有将字节码编译为机器语言的编译器，可以完全控制栈和寄存器的使用方法，因此在编译时确定栈图也不是什么不可思议的事情。

## 句柄区域与句柄标记

HotSpotVM 使用句柄区域（handle area）和句柄标记（handle mark）来管理指向调用栈内的对象的指针

