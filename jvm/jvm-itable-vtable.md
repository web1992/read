# itable vtable


HotSpot是Java虚拟机的一种实现，它使用了一种叫做vtable（虚函数表）和itable（接口函数表）的机制来进行方法调用。

下面是HotSpot使用vtable和itable进行方法调用的流程：

- Java源代码被编译成字节码，然后被HotSpot加载到内存中。
- 在加载字节码时，HotSpot为每个类和接口创建一个类对象（Class Object）并将其存储在内存中。
- 类对象包含类的方法信息，其中包括一个指向虚函数表（vtable）的指针和一个指向接口函数表（itable）的指针。虚函数表包含虚方法的地址，接口函数表包含接口方法的地址。
- 当对象被创建时，HotSpot为其分配一个内存区域，并在对象头中添加一个指向类对象的指针。这个指针可以让程序在运行时获取对象的类信息。
- 当程序调用一个对象的方法时，HotSpot根据对象的类信息获取该类的虚函数表或接口函数表，并在表中查找方法的地址。
- HotSpot将方法地址加载到寄存器中，并跳转到该地址开始执行方法。

这就是HotSpot使用vtable和itable进行方法调用的基本流程。虚函数表和接口函数表的机制使得Java的动态绑定成为可能，同时也提高了程序的性能。


itable 和 vtable 是编程中常见的术语，它们的作用与面向对象编程中的多态性相关。

itable 是 Interface Table 的缩写，也称为接口表。在 C++ 中，当一个类实现了一个纯虚函数（即一个没有实现的虚函数），编译器会为该类生成一个 itable，其中存储了该类实现的虚函数的地址。当该类的对象被实例化时，会在该对象的内存中存储一个指向 itable 的指针，以便在运行时查找并调用该对象的虚函数。

vtable 是 Virtual Table 的缩写，也称为虚函数表。在 C++ 中，当一个类有虚函数时，编译器会为该类生成一个 vtable，其中存储了该类所有虚函数的地址。当该类的对象被实例化时，会在该对象的内存中存储一个指向 vtable 的指针，以便在运行时查找并调用该对象的虚函数。

itable 和 vtable 都是实现多态性的关键。当一个基类指针指向一个派生类对象时，可以通过指针的虚函数表或接口表来调用派生类的虚函数或实现的接口函数，从而实现运行时多态性。


## vtableEntry

在 HotSpot 中，vtableEntry 中只包含了一个指向虚函数实现的方法的指针，用于确定虚函数的地址，而不包含其他信息。虚函数在虚函数表中的索引和大小等信息是通过固定的偏移量计算得到的，而不是存储在 vtableEntry 中。

在 HotSpot 中，每个类都有一个对应的虚函数表，该表中存储了该类的虚函数实现的地址。每个虚函数都有一个在表中的索引，通过这个索引可以访问到对应的虚函数实现的地址。在程序运行时，当调用一个虚函数时，HotSpot 会先根据对象的 oop 指针找到对象的 Klass 实例，然后从该 Klass 实例中获取虚函数表的指针，最后根据虚函数在虚函数表中的索引，找到对应的虚函数实现的地址，并调用该函数。


## itableOffsetEntry

```c++
//源代码位置：openjdk/hotspot/src/share/vm/oops/klassVtable.hpp

class itableOffsetEntry VALUE_OBJ_CLASS_SPEC {
 private:
  Klass*   _interface;
  int      _offset;
  ...
}
```

itableOffsetEntry 是在 Java 虚拟机中实现接口调用的一种数据结构。它是一个条目，用于存储一个接口方法在接口方法表中的偏移量。在这个结构体中，_interface 指针指向接口的元数据信息，而 _offset 变量存储了这个接口方法在接口方法表中的偏移量。

在 Java 中，一个类可以实现一个或多个接口，接口中定义了一组抽象方法，这些方法没有具体的实现代码。当一个类实现了一个接口时，它必须实现接口中定义的所有方法。在 Java 虚拟机中，每个接口都有一个对应的接口方法表，用于存储接口中定义的所有方法的地址。当一个类实现了一个接口时，它实现的所有接口方法的地址都需要存储在该类的方法表中，以便在运行时可以快速调用这些方法。

当程序调用一个接口方法时，Java 虚拟机需要动态地确定这个方法的地址，并进行调用。首先，它会根据对象的 oop 指针找到对象的 Klass 实例，然后从该 Klass 实例中获取接口方法表的指针，接着根据接口方法在接口方法表中的偏移量找到对应的接口方法的地址，最后调用该方法。

itableOffsetEntry 中的 _interface 指针和 _offset 变量就是为了存储接口方法在接口方法表中的偏移量而设计的。在运行时，Java 虚拟机会通过这些信息来确定接口方法的地址，并进行调用。

