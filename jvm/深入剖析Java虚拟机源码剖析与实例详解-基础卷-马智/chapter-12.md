# 第12章 Serial Old垃圾收集器

- Minor GC（YGC）
- FGC (Full GC)
- 标记活跃对象
- 计算活跃对象的地址
- 更新对象的引用地址
- 移动所有活跃对象
- 更新偏移表与卡表
- 计算活跃对象的优化（通过compact_top指针）
- 偏移表
- 卡表


## 回收过程

- 标记活跃对象
- 计算活跃对象的地址
- 更新对象的引用地址
- 移动所有活跃对象
- 更新偏移表与卡表

## FGC 触发

Serial Old垃圾收集器虽然是老年代收集器，但是在收集老年代对象的同时也会回收年轻代对象。Serial Old垃圾收集器所使用的垃圾回收算法是标记-压缩-清理算法。在回收阶段，Serial Old垃圾收集器会将标记对象越过堆的空闲区移动到堆的另一端，所有被移动的对象的引用也会被更新并指向新的位置

出现下面4种情况时，对象会进入老年代。

- 执行YGC时，To Survivor区不足以存放存活的对象，那么对象会直接进入老年代；
- 经过多次YGC后，如果存活对象的年龄达到了设定阈值，则会晋升到老年代；
- 根据动态年龄判定规则，如果To Survivor区中相同年龄的对象的总内存占据To Survivor区一半以上，那么大于此年龄的对象会直接进入老年代，不需要达到默认的分代年龄。
- 大对象：由-XX:PretenureSizeThreshold选项控制，若对象的内存容量大于此值，就会绕过新生代，直接在老年代中分配。

当晋升到老年代的对象大于老年代的剩余内存空间时，就会触发FGC，FGC处理的区域包括新生代和老年代。以下4种情况会触发FGC。

1. 调用System.gc()

对于HotSpot VM来说，调用System.gc()一定会触发一次FGC，增加了FGC的频率，因此一般不建议使用，最好让虚拟机自己去管理它的内存。

2. 存储大对象

所谓大对象，是指需要大量连续内存空间的Java对象。例如很长的数组，此种对象会直接进入老年代，而老年代虽然有很大的剩余空间，但是无法找到足够大的连续空间分配给当前对象，此种情况就会触发JVM进行FGC。

老年代空间只有在新生代对象转入及创建为大对象、大数组时才会出现空间不足的现象，如果执行FGC后空间仍然不足，则抛出`Java.lang.OutOfMemoryError`异常。

为了避免以上两种情况引起的FGC，调优时应尽量做到让对象在YGC阶段被回收，或者让对象在新生代多存活一段时间，以及不要创建过大的对象及数组。

3. 分配担保失败

空间分配担保：在执行YGC之前，首先会检查老年代最大可用的连续空间是否大于新生代所有对象的总空间。如果小于，说明YGC是不安全的，则会查看参数Handle-PromotionFailure是否被设置成了允许担保失败，如果不允许则直接触发FGC；如果允许，那么会进一步检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果小于也会触发FGC。

HotSpot VM为了避免由于新生代对象晋升到老年代导致老年代空间不足的现象，在执行YGC时做了一个判断，如果之前统计所得到的YGC晋升到老年代的平均大小大于老年代的剩余空间，那么就会直接触发FGC。

4. 元空间内存不足

Metaspace（元空间）在空间不足时会进行扩容，当扩容到了-XX:MetaspaceSize参数的指定值时也会触发FGC。

## 软引用

通常，调用must_clear_all_soft_refs()函数后会返回false，因为执行FGC可能是由于老年代垃圾多而导致内存不足，并不是内存紧张，所以不会通过回收软引用来释放更多的内存。如果执行FGC后内存仍然不足，紧接着会发生下一次FGC操作，那么这一次就会回收软引用；_max_level的值为1，代表的是代的最大索引值，年轻代为0，老年代为1。

## GC 过程

- mark_sweep_phase1()函数：标记所有活跃对象；
- mark_sweep_phase2()函数：计算所有活跃对象在压缩后的偏移地址；
- mark_sweep_phase3()函数：更新对象的引用地址；(主要是这个方法：`MarkSweep::adjust_pointer`)
- mark_sweep_phase4()函数：移动所有活跃对象到新的位置。


`计算所有活跃对象在压缩后的偏移地址` 此过程主要是对扫描对象，计算对象的新地址。（计算压缩后的地址，设置转发指针并更新压缩指针）

## 类加载器

所有加载的类都通过_next_link指针连接起来形成单链表，这样获取类加载器后就可以遍历所有由此类加载器加载的类了，当类加载器不卸载时，加载的类也不会卸载。类存储在元数据区，但是类中的_java_mirror引用的oop存储在堆中，因此在必要时还需要处理此oop。
