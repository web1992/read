# ç¬¬7ç«  äº‹ç‰©

- ACID
- åŸå­æ€§(atomicity)
- ä¸€è‡´æ€§(consistency)
- éš”ç¦»æ€§(isolation)
- æŒä¹…æ€§(durability)
- æ‰å¹³äº‹åŠ¡(Flat Transactions)
- å¸¦æœ‰ä¿å­˜ç‚¹çš„æ‰å¹³äº‹åŠ¡( Flat Transactions with Savepoints )
- é“¾äº‹åŠ¡(Chained Transactions )
- åµŒå¥—äº‹åŠ¡(Nested Transactions )
- åˆ†å¸ƒå¼äº‹åŠ¡(Distributed Transactions )
- é‡åšæ—¥å¿—ç¼“å†²(redo log buffer)
- é‡åšæ—¥å¿—æ–‡ä»¶(redo log file)
- fsync æ“ä½œ
- log block
- redo log
- undo log 
- log group
- LSN Log Sequence Number (æ—¥å¿—åºåˆ—å·)
- insert undo log
- update undo log
- purge æ“ä½œ
- MVCC äº‹ç‰©å¼•ç”¨ undo log
- ä¸¤é˜¶æ®µæäº¤ï¼š äºŒè¿›åˆ¶æ—¥å¿—+undo log 
- Binary Log Group Commit (BLGC)
- äº‹ç‰©ä¸­å‡ºç°å¼‚å¸¸ï¼Œäº‹ç‰©å¹¶ä¸ä¼šè‡ªåŠ¨å›æ»šï¼Œéœ€è¦æ˜ç¡®çš„æ‰§è¡Œ ROLLBACK åŠ¨ä½œè¿›è¡Œå›æ»š
- éšå¼æäº¤çš„SQLè¯­å¥
- äº‹ç‰©éš”ç¦»çº§åˆ«
- LOCK IN SHARE MODEï¼Œæ¯ä¸ªè¯»å–æ“ä½œåŠ ä¸€ä¸ªå…±äº«é”ã€‚
- STATEMENT åŸºäºSQL çš„æ—¥å¿—ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰
- ROWæ ¼å¼çš„äºŒè¿›åˆ¶ ï¼ˆå»ºè®®ä½¿ç”¨ï¼‰ 
- XA äº‹ç‰©
- é•¿äº‹ç‰©

## redo-log

é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œå³äº‹åŠ¡ACIDä¸­çš„Dã€‚å…¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆ:ä¸€æ˜¯å†…å­˜ä¸­çš„é‡åšæ—¥å¿—ç¼“å†²(redo log buffer)ï¼Œå…¶æ˜¯æ˜“å¤±çš„;äºŒæ˜¯é‡åšæ—¥å¿—æ–‡ä»¶(redo log file),å…¶æ˜¯æŒä¹…çš„ã€‚

InnoDBæ˜¯äº‹åŠ¡çš„å­˜å‚¨å¼•æ“ï¼Œå…¶é€šè¿‡Force Log at Commitæœºåˆ¶å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œå³å½“äº‹åŠ¡æäº¤(COMMIT)æ—¶ï¼Œå¿…é¡»å…ˆå°†è¯¥äº‹åŠ¡çš„æ‰€æœ‰æ—¥å¿—å†™å…¥åˆ°é‡åšæ—¥å¿—æ–‡ä»¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¾…äº‹åŠ¡çš„COMMITæ“ä½œå®Œæˆæ‰ç®—å®Œæˆã€‚è¿™é‡Œçš„æ—¥å¿—æ˜¯æŒ‡é‡åšæ—¥å¿—ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå³redo logå’Œundo logã€‚redo log ç”¨æ¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œundologç”¨æ¥å¸®åŠ©`äº‹åŠ¡å›æ»š`åŠ`MVCC`çš„åŠŸèƒ½ã€‚redo logåŸºæœ¬ä¸Šéƒ½æ˜¯é¡ºåºå†™çš„ï¼Œåœ¨æ•°æ®åº“è¿è¡Œæ—¶ä¸éœ€è¦å¯¹redo logçš„æ–‡ä»¶è¿›è¡Œè¯»å–æ“ä½œã€‚è€Œundo logæ˜¯éœ€è¦è¿›è¡Œéšæœºè¯»å†™çš„ã€‚

ä¸ºäº†ç¡®ä¿æ¯æ¬¡æ—¥å¿—éƒ½å†™å…¥é‡åšæ—¥å¿—æ–‡ä»¶ï¼Œåœ¨æ¯æ¬¡å°†é‡åšæ—¥å¿—ç¼“å†²å†™å…¥é‡åšæ—¥å¿—æ–‡ä»¶åï¼ŒInnoDBå­˜å‚¨å¼•æ“éƒ½éœ€è¦è°ƒç”¨ä¸€æ¬¡fsyncæ“ä½œã€‚ç”±äºé‡åšæ—¥å¿—æ–‡ä»¶æ‰“å¼€å¹¶æ²¡æœ‰ä½¿ç”¨`O_DIRECT`é€‰é¡¹ï¼Œå› æ­¤é‡åšæ—¥å¿—ç¼“å†²å…ˆå†™å…¥æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ã€‚ä¸ºäº†ç¡®ä¿é‡åšæ—¥å¿—å†™å…¥ç£ç›˜ï¼Œå¿…é¡»è¿›è¡Œä¸€æ¬¡fsyncæ“ä½œã€‚ç”±äºfsyncçš„æ•ˆç‡å–å†³äºç£ç›˜çš„æ€§èƒ½ï¼Œå› æ­¤ç£ç›˜çš„æ€§èƒ½å†³å®šäº†äº‹åŠ¡æäº¤çš„æ€§èƒ½ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åº“çš„æ€§èƒ½ã€‚

å‚æ•°`innodb_flush_log_at_trx_commit`ç”¨æ¥æ§åˆ¶é‡åšæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„ç­–ç•¥ã€‚è¯¥å‚æ•°çš„é»˜è®¤å€¼ä¸º1,è¡¨ç¤ºäº‹åŠ¡æäº¤æ—¶å¿…é¡»è°ƒç”¨ä¸€æ¬¡fsyncæ“ä½œã€‚è¿˜å¯ä»¥è®¾ç½®è¯¥å‚æ•°çš„å€¼ä¸º0å’Œ2ã€‚0 è¡¨ç¤ºäº‹åŠ¡æäº¤æ—¶ä¸è¿›è¡Œå†™å…¥é‡åšæ—¥å¿—æ“ä½œï¼Œè¿™ä¸ªæ“ä½œä»…åœ¨master threadä¸­å®Œæˆï¼Œè€Œåœ¨master threadä¸­æ¯1ç§’ä¼šè¿›è¡Œä¸€æ¬¡é‡åšæ—¥å¿—æ–‡ä»¶çš„fsyncæ“ä½œã€‚2è¡¨ç¤ºäº‹åŠ¡æäº¤æ—¶å°†é‡åšæ—¥å¿—å†™å…¥é‡åšæ—¥å¿—æ–‡ä»¶ï¼Œä½†ä»…å†™å…¥æ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜ä¸­ï¼Œä¸è¿›è¡Œfsync æ“ä½œã€‚`åœ¨è¿™ä¸ªè®¾ç½®ä¸‹ï¼Œå½“MySQLæ•°æ®åº“å‘ç”Ÿå®•æœºè€Œæ“ä½œç³»ç»Ÿä¸å‘ç”Ÿå®•æœºæ—¶ï¼Œå¹¶ä¸ä¼šå¯¼è‡´äº‹åŠ¡çš„ä¸¢å¤±`ã€‚è€Œå½“æ“ä½œç³»ç»Ÿå®•æœºæ—¶ï¼Œé‡å¯æ•°æ®åº“åä¼šä¸¢å¤±æœªä»æ–‡ä»¶ç³»ç»Ÿç¼“å­˜åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶é‚£éƒ¨åˆ†äº‹åŠ¡ã€‚

## undo-log

1.åŸºæœ¬æ¦‚å¿µ
é‡åšæ—¥å¿—è®°å½•äº†äº‹åŠ¡çš„è¡Œä¸ºï¼Œå¯ä»¥å¾ˆå¥½åœ°é€šè¿‡å…¶å¯¹`é¡µ`è¿›è¡Œâ€œé‡åšâ€æ“ä½œã€‚ä½†æ˜¯äº‹åŠ¡æœ‰æ—¶è¿˜éœ€è¦è¿›è¡Œå›æ»šæ“ä½œï¼Œè¿™æ—¶å°±éœ€è¦undoã€‚å› æ­¤åœ¨å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¸ä½†ä¼šäº§ç”Ÿredo,è¿˜ä¼šäº§ç”Ÿä¸€å®šé‡çš„undoã€‚è¿™æ ·å¦‚æœç”¨æˆ·æ‰§è¡Œçš„äº‹åŠ¡æˆ–è¯­å¥ç”±äºæŸç§åŸå› å¤±è´¥äº†ï¼Œåˆæˆ–è€…ç”¨æˆ·ç”¨ä¸€æ¡ROLLBACKè¯­å¥è¯·æ±‚å›æ»šï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™äº›undoä¿¡æ¯å°†æ•°æ®å›æ»šåˆ°ä¿®æ”¹ä¹‹å‰çš„æ ·å­ã€‚
redoå­˜æ”¾åœ¨é‡åšæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä¸redoä¸åŒï¼Œundoå­˜æ”¾åœ¨æ•°æ®åº“å†…éƒ¨çš„ä¸€ä¸ªç‰¹æ®Šæ®µ(segment)ä¸­ï¼Œè¿™ä¸ªæ®µç§°ä¸ºundoæ®µ(undo segment)ã€‚undo æ®µä½äºå…±äº«è¡¨ç©ºé—´å†…ã€‚

ç”¨æˆ·é€šå¸¸å¯¹undoæœ‰è¿™æ ·çš„è¯¯è§£:undoç”¨äºå°†æ•°æ®åº“`ç‰©ç†åœ°æ¢å¤`åˆ°æ‰§è¡Œè¯­å¥æˆ–äº‹åŠ¡ä¹‹å‰çš„æ ·å­ï¼Œä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚undoæ˜¯é€»è¾‘æ—¥å¿—ï¼Œå› æ­¤åªæ˜¯å°†æ•°æ®åº“é€»è¾‘åœ°æ¢å¤åˆ°åŸæ¥çš„æ ·å­ã€‚æ‰€æœ‰ä¿®æ”¹éƒ½è¢«é€»è¾‘åœ°å–æ¶ˆäº†,ä½†æ˜¯`æ•°æ®ç»“æ„`å’Œ`é¡µæœ¬èº«`åœ¨å›æ»šä¹‹åå¯èƒ½å¤§ä¸ç›¸åŒã€‚è¿™æ˜¯å› ä¸ºåœ¨å¤šç”¨æˆ·å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¯èƒ½ä¼šæœ‰æ•°åã€æ•°ç™¾ç”šè‡³æ•°åƒä¸ªå¹¶å‘äº‹åŠ¡ã€‚æ•°æ®åº“çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯åè°ƒå¯¹æ•°æ®è®°å½•çš„å¹¶å‘è®¿é—®ã€‚æ¯”å¦‚ï¼Œä¸€è¡Œä¿®æ”¹ã€‚å› æ­¤ï¼Œä¸èƒ½å°†ä¸€ä¸ªé¡µå›æ»šåˆ°äº‹åŠ¡å¼€å§‹çš„æ ·å­ï¼Œå› ä¸ºè¿™æ ·ä¼šå½±å“å…¶ä»–äº‹åŠ¡æ­£åœ¨è¿›è¡Œçš„å·¥ä½œã€‚

ä¾‹å¦‚ï¼Œç”¨æˆ·æ‰§è¡Œäº†ä¸€ä¸ªINSERT 10Wæ¡è®°å½•çš„äº‹åŠ¡ï¼Œè¿™ä¸ªäº‹åŠ¡ä¼šå¯¼è‡´åˆ†é…ä¸€ä¸ªæ–°çš„æ®µï¼Œå³è¡¨ç©ºé—´ä¼šå¢å¤§ã€‚åœ¨ç”¨æˆ·æ‰§è¡ŒROLLBACKæ—¶ï¼Œä¼šå°†æ’å…¥çš„äº‹åŠ¡è¿›è¡Œå›æ»šï¼Œä½†æ˜¯è¡¨ç©ºé—´çš„å¤§å°å¹¶ä¸ä¼šå› æ­¤è€Œæ”¶ç¼©ã€‚å› æ­¤ï¼Œå½“InnoDBå­˜å‚¨å¼•æ“å›æ»šæ—¶ï¼Œ`å®ƒå®é™…ä¸Šåšçš„æ˜¯ä¸å…ˆå‰ç›¸åçš„å·¥ä½œ`ã€‚å¯¹äºæ¯ä¸ªINSERTï¼ŒInnoDB å­˜å‚¨å¼•æ“ä¼šå®Œæˆä¸€ä¸ªDELETE;å¯¹äºæ¯ä¸ªDELETEï¼ŒInnoDB å­˜å‚¨å¼•æ“ä¼šæ‰§è¡Œä¸€ä¸ªINSERT;å¯¹äºæ¯ä¸ªUPDATEï¼ŒInnoDB å­˜å‚¨å¼•æ“ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„UPDATE,å°†ä¿®æ”¹å‰çš„è¡Œæ”¾å›å»ã€‚é™¤äº†å›æ»šæ“ä½œï¼Œundoçš„å¦ä¸€ä¸ªä½œç”¨æ˜¯`MVCC`ï¼Œå³åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­MVCCçš„å®ç°æ˜¯é€šè¿‡undoæ¥å®Œæˆã€‚å½“ç”¨æˆ·è¯»å–ä¸€è¡Œè®°å½•æ—¶ï¼Œè‹¥è¯¥è®°å½•å·²ç»è¢«å…¶ä»–äº‹åŠ¡å ç”¨ï¼Œå½“å‰äº‹åŠ¡å¯ä»¥é€šè¿‡undoè¯»å–ä¹‹å‰çš„è¡Œç‰ˆæœ¬ä¿¡æ¯ï¼Œä»¥æ­¤å®ç°`éé”å®šè¯»å–`ã€‚æœ€åä¹Ÿæ˜¯æœ€ä¸ºé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œundo logä¼šäº§ç”Ÿredo log,ä¹Ÿå°±æ˜¯undo logçš„äº§ç”Ÿä¼šä¼´éšç€redo logçš„äº§ç”Ÿï¼Œè¿™æ˜¯å› ä¸ºundo logä¹Ÿéœ€è¦æŒä¹…æ€§çš„ä¿æŠ¤ã€‚

## purge

deleteå’Œupdateæ“ä½œå¯èƒ½å¹¶ä¸ç›´æ¥åˆ é™¤åŸæœ‰çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¯¹ä¸Šä¸€å°èŠ‚æ‰€äº§ç”Ÿçš„è¡¨tæ‰§è¡Œå¦‚ä¸‹çš„SQLè¯­å¥:
```
DELETE FROM t WHERE a=1;
```

è¡¨tä¸Šåˆ—aæœ‰èšé›†ç´¢å¼•ï¼Œåˆ—bä¸Šæœ‰è¾…åŠ©ç´¢å¼•ã€‚å¯¹äºä¸Šè¿°çš„deleteæ“ä½œï¼Œé€šè¿‡å‰é¢å…³äºundo logçš„ä»‹ç»å·²ç»çŸ¥é“ä»…æ˜¯å°†ä¸»é”®åˆ—ç­‰äº1çš„è®°å½•delete fagè®¾ç½®ä¸º1ï¼Œè®°å½•å¹¶æ²¡æœ‰è¢«åˆ é™¤ï¼Œå³è®°å½•è¿˜æ˜¯å­˜åœ¨äºB+æ ‘ä¸­ã€‚å…¶æ¬¡ï¼Œå¯¹è¾…åŠ©ç´¢å¼•ä¸Šaç­‰äº1, bç­‰äº1çš„è®°å½•åŒæ ·æ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œç”šè‡³æ²¡æœ‰äº§ç”Ÿundo logã€‚è€ŒçœŸæ­£åˆ é™¤è¿™è¡Œè®°å½•çš„æ“ä½œå…¶å®è¢«â€œå»¶æ—¶â€äº†ï¼Œæœ€ç»ˆåœ¨purgeæ“ä½œä¸­å®Œæˆã€‚

purgeç”¨äºæœ€ç»ˆå®Œæˆdeleteå’Œupdateæ“ä½œã€‚è¿™æ ·è®¾è®¡æ˜¯å› ä¸ºInnoDBå­˜å‚¨å¼•æ“æ”¯æŒMVCCï¼Œæ‰€ä»¥è®°å½•ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶ç«‹å³è¿›è¡Œå¤„ç†ã€‚è¿™æ—¶å…¶ä»–äº‹ç‰©å¯èƒ½æ­£åœ¨å¼•ç”¨è¿™è¡Œï¼Œæ•…InnoDBå­˜å‚¨å¼•æ“éœ€è¦ä¿å­˜è®°å½•ä¹‹å‰çš„ç‰ˆæœ¬ã€‚è€Œæ˜¯å¦å¯ä»¥åˆ é™¤è¯¥æ¡è®°å½•é€šè¿‡purgeæ¥è¿›è¡Œåˆ¤æ–­ã€‚è‹¥è¯¥è¡Œè®°å½•å·²ä¸è¢«ä»»ä½•å…¶ä»–äº‹åŠ¡å¼•ç”¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡ŒçœŸæ­£çš„deleteæ“ä½œã€‚å¯è§ï¼Œpurgeæ“ä½œæ˜¯æ¸…ç†ä¹‹å‰çš„deleteå’Œupdateæ“ä½œï¼Œå°†ä¸Šè¿°æ“ä½œâ€œæœ€ç»ˆâ€å®Œæˆã€‚è€Œå®é™…æ‰§è¡Œçš„æ“ä½œä¸ºdeleteæ“ä½œï¼Œæ¸…ç†ä¹‹å‰è¡Œè®°å½•çš„ç‰ˆæœ¬ã€‚

## Group Commit

å¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œäº‹åŠ¡æäº¤æ—¶ä¼šè¿›è¡Œä¸¤ä¸ªé˜¶æ®µçš„æ“ä½œ:
- 1)ä¿®æ”¹å†…å­˜ä¸­äº‹åŠ¡å¯¹åº”çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å°†æ—¥å¿—å†™å…¥é‡åšæ—¥å¿—ç¼“å†²ã€‚
- 2)è°ƒç”¨fsyncå°†ç¡®ä¿æ—¥å¿—éƒ½ä»é‡åšæ—¥å¿—ç¼“å†²å†™å…¥ç£ç›˜ã€‚

æ­¥éª¤2)ç›¸å¯¹æ­¥éª¤1)æ˜¯ä¸€ä¸ªè¾ƒæ…¢çš„è¿‡ç¨‹ï¼Œè¿™æ˜¯å› ä¸ºå­˜å‚¨å¼•æ“éœ€è¦ä¸ç£ç›˜æ‰“äº¤é“ã€‚ä½†å½“æœ‰äº‹åŠ¡è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹æ—¶ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥è¿›è¡Œæ­¥éª¤1)çš„æ“ä½œï¼Œæ­£åœ¨æäº¤çš„äº‹ç‰©å®Œæˆæäº¤æ“ä½œåï¼Œå†æ¬¡è¿›è¡Œæ­¥éª¤2)æ—¶ï¼Œå¯ä»¥å°†å¤šä¸ªäº‹åŠ¡çš„é‡åšæ—¥å¿—é€šè¿‡ä¸€æ¬¡fsyncåˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™æ ·å°±å¤§å¤§åœ°å‡å°‘äº†ç£ç›˜çš„å‹åŠ›ï¼Œä»è€Œæé«˜äº†æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚å¯¹äºå†™å…¥æˆ–æ›´æ–°è¾ƒä¸ºé¢‘ç¹çš„æ“ä½œï¼Œgroup commitçš„æ•ˆæœå°¤ä¸ºæ˜æ˜¾ã€‚

ç„¶è€Œåœ¨InnoDB1.2ç‰ˆæœ¬ä¹‹å‰ï¼Œåœ¨å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„group commitåŠŸèƒ½ä¼šå¤±æ•ˆï¼Œä»è€Œå¯¼è‡´æ€§èƒ½çš„ä¸‹é™ã€‚å¹¶ä¸”åœ¨çº¿ç¯å¢ƒå¤šä½¿ç”¨replicationç¯å¢ƒï¼Œå› æ­¤äºŒè¿›åˆ¶æ—¥å¿—çš„é€‰é¡¹åŸºæœ¬éƒ½ä¸ºå¼€å¯çŠ¶æ€ï¼Œå› æ­¤è¿™ä¸ªé—®é¢˜å°¤ä¸ºæ˜¾è‘—ã€‚å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯åœ¨å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åï¼Œä¸ºäº†ä¿è¯å­˜å‚¨å¼•æ“å±‚ä¸­çš„äº‹åŠ¡å’ŒäºŒè¿›åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ï¼ŒäºŒè€…ä¹‹é—´ä½¿ç”¨äº†ä¸¤é˜¶æ®µäº‹åŠ¡ï¼Œå…¶æ­¥éª¤å¦‚ä¸‹:
- 1) å½“äº‹åŠ¡æäº¤æ—¶InnoDBå­˜å‚¨å¼•æ“è¿›è¡Œprepareæ“ä½œã€‚
- 2) MySQLæ•°æ®åº“ä¸Šå±‚å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ã€‚
- 3) InnoDBå­˜å‚¨å¼•æ“å±‚å°†æ—¥å¿—å†™å…¥é‡åšæ—¥å¿—æ–‡ä»¶ã€‚
    - a)ä¿®æ”¹å†…å­˜ä¸­äº‹åŠ¡å¯¹åº”çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å°†æ—¥å¿—å†™å…¥é‡åšæ—¥å¿—ç¼“å†²ã€‚
    - b)è°ƒç”¨fsyncå°†ç¡®ä¿æ—¥å¿—éƒ½ä»é‡åšæ—¥å¿—ç¼“å†²å†™å…¥ç£ç›˜ã€‚

## BLGC Binary Log Group Commit

![å›¾7-21 MySQL 5.6 BLGCçš„å®ç°æ–¹å¼](./images/mysql-innodb-chapter-07-21.drawio.svg)

åœ¨MySQLæ•°æ®åº“ä¸Šå±‚è¿›è¡Œæäº¤æ—¶é¦–å…ˆæŒ‰é¡ºåºå°†å…¶æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªäº‹åŠ¡ç§°ä¸ºleader,å…¶ä»–äº‹åŠ¡ç§°ä¸ºfollower, leader æ§åˆ¶ç€follower çš„è¡Œä¸ºã€‚BLGCçš„æ­¥

éª¤åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µ:
- Flushé˜¶æ®µï¼Œå°†æ¯ä¸ªäº‹åŠ¡çš„äºŒè¿›åˆ¶æ—¥å¿—å†™å…¥å†…å­˜ä¸­ã€‚
- Syncé˜¶æ®µï¼Œå°†å†…å­˜ä¸­çš„äºŒè¿›åˆ¶æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œè‹¥é˜Ÿåˆ—ä¸­æœ‰å¤šä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆä»…ä¸€æ¬¡fsyncæ“ä½œå°±å®Œæˆäº†äºŒè¿›åˆ¶æ—¥å¿—çš„å†™å…¥ï¼Œè¿™å°±æ˜¯BLGCã€‚
- Commité˜¶æ®µï¼Œleader æ ¹æ®é¡ºåºè°ƒç”¨å­˜å‚¨å¼•æ“å±‚äº‹åŠ¡çš„æäº¤ï¼ŒInnoDBå­˜å‚¨å¼•æ“æœ¬å°±æ”¯æŒgroup commitï¼Œ å› æ­¤ä¿®å¤äº†åŸå…ˆç”±äºé”prepare_commit_mutex å¯¼è‡´ group commitå¤±æ•ˆçš„é—®é¢˜ã€‚

å½“æœ‰ä¸€ç»„äº‹åŠ¡åœ¨è¿›è¡ŒCommité˜¶æ®µæ—¶ï¼Œå…¶ä»–æ–°äº‹ç‰©å¯ä»¥è¿›è¡ŒFlushé˜¶æ®µï¼Œä»è€Œä½¿group commitä¸æ–­ç”Ÿæ•ˆã€‚å½“ç„¶group commitçš„æ•ˆæœç”±é˜Ÿåˆ—ä¸­äº‹åŠ¡çš„æ•°é‡å†³å®šï¼Œè‹¥æ¯æ¬¡é˜Ÿåˆ—ä¸­ä»…æœ‰ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆå¯èƒ½æ•ˆæœå’Œä¹‹å‰å·®ä¸å¤šï¼Œç”šè‡³ä¼šæ›´å·®ã€‚ä½†å½“æäº¤çš„äº‹åŠ¡è¶Šå¤šæ—¶ï¼Œgroup commitçš„æ•ˆæœè¶Šæ˜æ˜¾ï¼Œæ•°æ®åº“æ€§èƒ½çš„æå‡ä¹Ÿå°±è¶Šå¤§ã€‚

> ğŸ¶å¤‡æ³¨ğŸ¶
> æœ¬è´¨è§£å†³çš„é—®é¢˜ï¼š äºŒè¿›åˆ¶æ—¥å¿—ä¸InnoDBå­˜å‚¨å¼•æ“é‡ç½®æ—¥å¿—çš„é¡ºåºé—®é¢˜ã€‚


## éšå¼æäº¤çš„SQLè¯­å¥

ä»¥ä¸‹è¿™äº›SQLè¯­å¥ä¼šäº§ç”Ÿä¸€ä¸ªéšå¼çš„æäº¤æ“ä½œï¼Œå³æ‰§è¡Œå®Œè¿™äº›è¯­å¥åï¼Œä¼šæœ‰ä¸€ä¸ªéšå¼çš„COMMITæ“ä½œã€‚
DDLè¯­å¥: ALTER DATABASE...UPGRADE DATA DIRECTORY NAME,
ALTER EVENT, ALTER PROCEDURE, ALTER TABLE, ALTER VIEW,
CREATE DATABASE, CREATE EVENT, CREATE INDEX, CREATE
PROCEDURE, CREATE TABLE, CREATE TRIGGER, CREATE VIEW ,
DROP DATABASE, DROP EVENT, DROP INDEX, DROP PROCEDURE,
DROP TABLE, DROP TRIGGER, DROP VIEW, RENAME TABLE,
TRUNCATE TABLE.

ç”¨æ¥éšå¼åœ°ä¿®æ”¹MySQLæ¶æ„çš„æ“ä½œ: CREATE USERã€DROP USERã€GRANTã€ENAME USERã€ REVOKE SET PASSWORD.

ç®¡ç†è¯­å¥: ANALYZE TABLEã€ CACHE INDEXã€ CHECK TABLEã€ LOAD INDEX INTO CACHEã€ OPTIMIZE TABLEã€ REPAIR TABLE.


## äº‹ç‰©éš”ç¦»çº§åˆ«

InnoDBå­˜å‚¨å¼•æ“é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯REPEATABLE READï¼Œä½†æ˜¯ä¸æ ‡å‡†SQLä¸åŒçš„æ˜¯ï¼ŒInnoDB å­˜å‚¨å¼•æ“åœ¨REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œ
ä½¿ç”¨Next-Key Locké”çš„ç®—æ³•ï¼Œå› æ­¤é¿å…å¹»è¯»çš„äº§ç”Ÿã€‚è¿™ä¸å…¶ä»–æ•°æ®åº“ç³»ç»Ÿ(å¦‚Microsoft SQL Serveræ•°æ®åº“)æ˜¯ä¸åŒçš„ã€‚
æ‰€ä»¥è¯´ï¼ŒInnoDB å­˜å‚¨å¼•æ“åœ¨é»˜è®¤çš„REPEATABLE READçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹å·²ç»èƒ½å®Œå…¨ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚ï¼Œå³è¾¾åˆ°SQLæ ‡å‡†çš„SERIALIZABLEéš”ç¦»çº§åˆ«ã€‚

## XA

æœ€ä¸ºå¸¸è§çš„å†…éƒ¨XAäº‹åŠ¡å­˜åœ¨äºbinlogä¸InnoDBå­˜å‚¨å¼•æ“ä¹‹é—´ã€‚ç”±äºå¤åˆ¶çš„éœ€è¦ï¼Œå› æ­¤ç›®å‰ç»å¤§å¤šæ•°çš„æ•°æ®åº“éƒ½å¼€å¯äº†`binlog`åŠŸèƒ½ã€‚åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œå…ˆå†™äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå†å†™InnoDBå­˜å‚¨å¼•æ“çš„é‡åšæ—¥å¿—ã€‚å¯¹ä¸Šè¿°ä¸¤ä¸ªæ“ä½œçš„è¦æ±‚ä¹Ÿæ˜¯åŸå­çš„ï¼Œå³äºŒè¿›åˆ¶æ—¥å¿—å’Œé‡åšæ—¥å¿—å¿…é¡»åŒæ—¶å†™å…¥ã€‚è‹¥äºŒè¿›åˆ¶æ—¥å¿—å…ˆå†™äº†ï¼Œè€Œåœ¨å†™å…¥InnoDBå­˜å‚¨å¼•æ“æ—¶å‘ç”Ÿäº†å®•æœºï¼Œé‚£ä¹ˆslaveå¯èƒ½ä¼šæ¥æ”¶åˆ°masterä¼ è¿‡å»çš„äºŒè¿›åˆ¶æ—¥å¿—å¹¶æ‰§è¡Œï¼Œæœ€ç»ˆå¯¼è‡´äº†ä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µã€‚

åœ¨å›¾7-23ä¸­ï¼Œå¦‚æœæ‰§è¡Œå®Œâ‘ ã€â‘¡ååœ¨æ­¥éª¤â‘¢ä¹‹å‰MySQLæ•°æ®åº“å‘ç”Ÿäº†å®•æœºï¼Œåˆ™ä¼šå‘ç”Ÿä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒMySQLæ•°æ®åº“åœ¨binlogä¸InnoDBå­˜å‚¨å¼•æ“ä¹‹é—´é‡‡ç”¨XAäº‹åŠ¡ã€‚
å½“äº‹åŠ¡æäº¤æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå…ˆåšä¸€ä¸ªPREPAREæ“ä½œï¼Œå°†äº‹åŠ¡çš„xidå†™å…¥ï¼Œæ¥ç€è¿›è¡ŒäºŒè¿›åˆ¶æ—¥å¿—çš„å†™å…¥ï¼Œå¦‚å›¾7-24æ‰€ç¤ºã€‚
å¦‚æœåœ¨InnoDBå­˜å‚¨å¼•æ“æäº¤å‰ï¼ŒMySQLæ•°æ®åº“å®•æœºäº†ï¼Œé‚£ä¹ˆMySQLæ•°æ®åº“åœ¨é‡å¯åä¼šå…ˆæ£€æŸ¥å‡†å¤‡çš„UXIDäº‹åŠ¡æ˜¯å¦å·²ç»æäº¤ï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™åœ¨å­˜å‚¨å¼•æ“å±‚å†è¿›è¡Œä¸€æ¬¡æäº¤æ“ä½œã€‚

å›¾7-23å®•æœºå¯¼è‡´ replicationä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µ

![å›¾7-23å®•æœºå¯¼è‡´ replicationä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µ](./images/mysql-innodb-chapter-07-23.drawio.svg)

å›¾7-24 MySQLæ•°æ®åº“é€šè¿‡å†…éƒ¨XAäº‹åŠ¡ä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´

![å›¾7-24 MySQLæ•°æ®åº“é€šè¿‡å†…éƒ¨XAäº‹åŠ¡ä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´](./images/mysql-innodb-chapter-07-24.drawio.svg)

> XA æ­¤å¤„ä¸»è¦è§£å†³ binlog ä¸ redo log çš„ä¸ä¸€è‡´

## ä¸å¥½çš„äº‹ç‰©ä¹ æƒ¯

- åœ¨å¾ªç¯ä¸­æäº¤
- ä½¿ç”¨è‡ªåŠ¨æäº¤
- ä½¿ç”¨è‡ªåŠ¨å›æ»š

## Links 

- [MySQLä¸¤é˜¶æ®µæäº¤ï¼ˆRedo.log binlog.logï¼‰](https://blog.csdn.net/weixin_41796257/article/details/108934919)